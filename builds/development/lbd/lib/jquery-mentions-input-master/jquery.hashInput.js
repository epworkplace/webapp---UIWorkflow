!function(e,t,n){var a={BACKSPACE:8,TAB:9,RETURN:13,ESC:27,LEFT:37,UP:38,RIGHT:39,DOWN:40,COMMA:188,SPACE:32,HOME:36,END:35},o={defaultValue1:"",triggerChar:"#",onDataRequest:e.noop,minChars:2,allowRepeat:!1,showAvatars:!0,elastic:!0,defaultValue:"",onCaret:!1,classes:{autoCompleteItemActive:"active"},templates:{wrapper:t.template('<div class="mentions-input-box"></div>'),autocompleteList:t.template('<div class="mentions-autocomplete-list"></div>'),autocompleteListItem:t.template('<li datas-ref-id="<%= id %>" datas-ref-type="<%= type %>" datas-display="<%= display %>"><%= content %></li>'),autocompleteListItemAvatar:t.template('<img src="<%= avatar %>" />'),autocompleteListItemIcon:t.template('<div class="icon <%= icon %>"></div>'),mentionsOverlay:t.template('<div class="mentions"><div></div></div>'),mentionItemSyntax:t.template("[<%=value %>](<%= type %>:<%= id %>)"),mentionItemHighlight:t.template("<strong><span><%=value %></span></strong>")}},r={htmlEncode:function(e){return t.escape(e)},regexpEncode:function(e){return e.replace(/([.*+?^=!:${}()|\[\]\/\\])/g,"\\$1")},highlightTerm:function(e,t){return t||t.length?e.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+t+")(?![^<>]*>)(?![^&;]+;)","gi"),"<b>$1</b>"):e},setCaratPosition:function(e,t){if(e.createTextRange){var n=e.createTextRange();n.move("character",t),n.select()}else e.selectionStart?(e.focus(),e.setSelectionRange(t,t)):e.focus()},rtrim:function(e){return e.replace(/\s+$/,"")}},s=function(n){function s(){"true"!==(M=e(L)).attr("datas-mentions-input")&&(O=M.parent(),H=e(n.templates.wrapper()),M.wrapAll(H),H=O.find("> div.mentions-input-box"),M.attr("datas-mentions-input","true"),M.bind("keydown",T),M.bind("keypress",y),M.bind("click",b),M.bind("blur",w),navigator.userAgent.indexOf("MSIE 8")>-1?M.bind("propertychange",C):M.bind("input",C),n.elastic&&M.elastic())}function l(){(N=e(n.templates.autocompleteList())).appendTo(H),N.delegate("li","mousedown",x)}function c(){(D=e(n.templates.mentionsOverlay())).prependTo(H)}function d(){var e=h();t.each(F,function(t){var i=n.templates.mentionItemSyntax(t);e=e.replace(new RegExp(r.regexpEncode(t.value),"g"),i)});var i=e;t.each(F,function(e){var a=t.extend({},e,{value:e.value}),o=n.templates.mentionItemSyntax(a),s=n.templates.mentionItemHighlight(a);i=i.replace(new RegExp(r.regexpEncode(o),"g"),s)}),i=i.replace(/\n/g,"<br />"),i=i.replace(/ {2}/g,"&nbsp; "),M.data("messageText",e),M.trigger("updated"),D.find("div").html(i)}function p(){W=[]}function u(){var e=h();F=t.reject(F,function(t,n){return!t.value||-1==e.indexOf(t.value)}),F=t.compact(F)}function f(e){for(var i=h(),a=M[0].selectionStart,o=!1,s=!1,l=new RegExp("\\"+n.triggerChar+j,"gi");l.exec(i);)(!1===o||Math.abs(l.lastIndex-a)<o)&&(o=Math.abs(l.lastIndex-a),s=l.lastIndex);var c=s-j.length-1,u=s,f=i.substr(0,c),g=i.substr(u,i.length),m=(f+e.value).length+1;t.find(F,function(t){return t.id==e.id})||F.push(e),p(),j="",E();var v=f+n.triggerChar+e.value+" "+g;M.val(v),M.trigger("mention"),d(),M.focus(),r.setCaratPosition(M[0],m)}function h(){return e.trim(M.val())}function g(t){var n,i,a,o,r,s,l,c,d,p,u;if((d=t[0])&&e(d).is("textarea")&&null!=d.selectionEnd){for(l={position:"absolute",overflow:"auto",whiteSpace:"pre-wrap",wordWrap:"break-word",boxSizing:"content-box",top:0,left:-9999},p=0,u=(c=["boxSizing","fontFamily","fontSize","fontStyle","fontVariant","fontWeight","height","letterSpacing","lineHeight","paddingBottom","paddingLeft","paddingRight","paddingTop","textDecoration","textIndent","textTransform","width","word-spacing"]).length;p<u;p++)r=c[p],l[r]=e(d).css(r);return a=document.createElement("div"),e(a).css(l),e(d).after(a),i=document.createTextNode(d.value.substring(0,d.selectionEnd)),n=document.createTextNode(d.value.substring(d.selectionEnd)),o=document.createElement("span"),o.innerHTML="&nbsp;",a.appendChild(i),a.appendChild(o),a.appendChild(n),a.scrollTop=d.scrollTop,s=e(o).position(),e(a).remove(),s}}function m(t){var n,i,a,o,r,s,l,c,d,p,u;if((d=t[0])&&e(d).is("textarea")&&null!=d.selectionEnd){for(l={position:"absolute",overflow:"auto",whiteSpace:"pre-wrap",wordWrap:"break-word",boxSizing:"content-box",top:0,left:-9999},p=0,u=(c=["boxSizing","fontFamily","fontSize","fontStyle","fontVariant","fontWeight","height","letterSpacing","lineHeight","paddingBottom","paddingLeft","paddingRight","paddingTop","textDecoration","textIndent","textTransform","width","word-spacing"]).length;p<u;p++)r=c[p],l[r]=e(d).css(r);return a=document.createElement("div"),e(a).css(l),e(d).after(a),i=document.createTextNode(d.value.substring(0,d.selectionEnd)),n=document.createTextNode(d.value.substring(d.selectionEnd)),o=document.createElement("span"),o.innerHTML="&nbsp;",a.appendChild(i),a.appendChild(o),a.appendChild(n),a.scrollTop=d.scrollTop,s=e(o).offset(),e(a).remove(),s}}function v(){var t=e(M).offset().top,n=e("body").offset().top;e(window).scrollTop()>t&&e(window).scrollTop(t-n)}function x(t){var n=e(this);return f(P[n.attr("datas-uid")]),v(),!1}function b(e){p();var a=this.selectionStart,o=h().substring(" ",a),r=o.substring(o.lastIndexOf(" ")+1).toLowerCase();if(r.charAt(0)===n.triggerChar){var s=r;for(i=0;i<s.length;i++)W.push(s[i]);t.defer(t.bind(A,this,s))}}function w(e){E()}function C(e){d(),u();var i=t.lastIndexOf(W,n.triggerChar);i>-1&&(j=W.slice(i+1).join(""),j=r.rtrim(j),t.defer(t.bind(A,this,j)))}function y(e){if(e.keyCode!==a.BACKSPACE){var t=String.fromCharCode(e.which||e.keyCode);W.push(t)}}function T(n){if(n.keyCode===a.LEFT||n.keyCode===a.RIGHT||n.keyCode===a.HOME||n.keyCode===a.END)return t.defer(p),void(navigator.userAgent.indexOf("MSIE 9")>-1&&t.defer(d));{if(n.keyCode!==a.BACKSPACE){if(!N.is(":visible"))return!0;switch(n.keyCode){case a.DOWN:var i=null;return(i=n.keyCode===a.DOWN?B&&B.length?B.next():N.find("li").first():e(B).prev()).length&&I(i),!1;case a.RETURN:case a.TAB:if(B&&B.length)return B.trigger("mousedown"),!1}return!0}W=W.slice(0,-1+W.length)}}function E(){B=null,N.empty().hide()}function I(e){e.addClass(n.classes.autoCompleteItemActive),e.siblings().removeClass(n.classes.autoCompleteItemActive),B=e}function S(i,a){if(N.show(),!n.allowRepeat){var o=t.pluck(F,"value");a=t.reject(a,function(e){return t.include(o,e.name)})}if(a.length){N.empty();var s=e("<ul>").appendTo(N).hide();t.each(a,function(a,o){var l=t.uniqueId("mention_");P[l]=t.extend({},a,{value:a.name});var c=e(n.templates.autocompleteListItem({id:a.id,display:a.name,type:a.type,content:r.highlightTerm(a.display?a.display:a.name,i)})).attr("datas-uid",l);if(0===o&&I(c),n.showAvatars){e(a.avatar?n.templates.autocompleteListItemAvatar({avatar:a.avatar}):n.templates.autocompleteListItemIcon({icon:a.icon})).prependTo(c)}c=c.appendTo(s)}),N.show(),n.onCaret&&R(N,M),s.show()}else E()}function A(e){e&&e.length&&e.length>=n.minChars?n.onDataRequest.call(this,"search",e,function(t){S(e,t)}):E()}function R(e,t){var n=e.css("position");if("absolute"==n){var i=g(t),a=parseInt(t.css("line-height"),10)||18;e.css("width","15em"),e.css("left",i.left),e.css("top",a+i.top);var o=t.offset().left+t.width(),r=e.offset().left+e.width();o<=r&&e.css("left",Math.abs(e.position().left-(r-o)))}else if("fixed"==n){var s=m(t),a=parseInt(t.css("line-height"),10)||18;e.css("width","15em"),e.css("left",s.left+1e4),e.css("top",a+s.top)}}function k(e){F=[];for(var t,i=e,a=new RegExp("("+n.triggerChar+")\\[(.*?)\\]\\((.*?):(.*?)\\)","gi"),o=i;null!=(t=a.exec(i));)o=o.replace(t[0],t[1]+t[2]),F.push({id:t[4],type:t[3],value:t[2],trigger:t[1]});M.val(o),d()}var L,M,O,N,H,D,B,F=[],P={},W=[],j="";return n=e.extend(!0,{},o,n),{init:function(e){L=e,s(),l(),c(),k(n.defaultValue),n.prefillMention&&f(n.prefillMention)},val:function(e){t.isFunction(e)&&e.call(this,F.length?M.data("messageText"):h())},reset:function(){k()},reinit:function(){k(!1)},getMentions:function(e){t.isFunction(e)&&e.call(this,F)}}};e.fn.hashInput=function(n,i){var a=arguments;return"object"!=typeof n&&n||(i=n),this.each(function(){var o=e.data(this,"hashInput")||e.data(this,"hashInput",new s(i));return t.isFunction(o[n])?o[n].apply(this,Array.prototype.slice.call(a,1)):"object"!=typeof n&&n?void e.error("Method "+n+" does not exist"):o.init.call(this,this)})}}(jQuery,_);