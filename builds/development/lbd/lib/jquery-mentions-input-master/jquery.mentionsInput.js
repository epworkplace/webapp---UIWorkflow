!function(e,t,n){var a={BACKSPACE:8,TAB:9,RETURN:13,ESC:27,LEFT:37,UP:38,RIGHT:39,DOWN:40,COMMA:188,SPACE:32,HOME:36,END:35},i={triggerChar:"@",onDataRequest:e.noop,minChars:2,showAvatars:!0,classes:{autoCompleteItemActive:"active"},templates:{wrapper:t.template('<div class="mentions-input-box"></div>'),autocompleteList:t.template('<div class="mentions-autocomplete-list"></div>'),autocompleteListItem:t.template('<li data-ref-id="<%= id %>" data-ref-type="<%= type %>" data-display="<%= display %>"><%= content %></li>'),autocompleteListItemAvatar:t.template('<img  src="<%= avatar %>" />'),autocompleteListItemIcon:t.template('<div class="icon <%= icon %>"></div>'),mentionsOverlay:t.template('<div class="mentions"><div></div></div>'),mentionItemSyntax:t.template("@[<%= value %>](<%= type %>:<%= id %>)"),mentionItemHighlight:t.template("<strong><span><%= value %></span></strong>")}},o={htmlEncode:function(e){return t.escape(e)},highlightTerm:function(e,t){return t||t.length?e.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+t+")(?![^<>]*>)(?![^&;]+;)","gi"),"<b>$1</b>"):e},setCaratPosition:function(e,t){if(e.createTextRange){var n=e.createTextRange();n.move("character",t),n.select()}else e.selectionStart?(e.focus(),e.setSelectionRange(t,t)):e.focus()},rtrim:function(e){return e.replace(/\s+$/,"")}},l=function(n){function i(){"true"!=(x=e(n)).attr("data-mentions-input")&&(A=x.parent(),k=e(T.templates.wrapper()),x.wrapAll(k),k=A.find("> div"),x.attr("data-mentions-input","true"),x.bind("keydown",g),x.bind("keypress",f),x.bind("input",h),x.bind("click",v),x.elastic())}function l(){(b=e(T.templates.autocompleteList())).appendTo(k),b.delegate("li","click",d)}function r(){(w=e(T.templates.mentionsOverlay())).prependTo(k)}function s(){var e=m();t.each(O,function(t){var n=T.templates.mentionItemSyntax({value:t.value,type:t.type,id:t.id});e=e.replace(t.value,n)});var n=o.htmlEncode(e);t.each(O,function(e){var t=T.templates.mentionItemSyntax({value:o.htmlEncode(e.value),type:e.type,id:e.id}),a=T.templates.mentionItemHighlight({value:o.htmlEncode(e.value)});n=n.replace(t,a)}),n=n.replace(/\n/g,"<br />"),n=n.replace(/ {2}/g,"&nbsp; "),x.data("messageText",e),w.find("div").html(n)}function c(){S=[]}function u(){var e=m();O=t.reject(O,function(t,n){return!t.value||-1==e.indexOf(t.value)}),O=t.compact(O)}function p(e,t,n){var a=m(),i=new RegExp("\\"+T.triggerChar+L,"gi");i.exec(a);var l=i.lastIndex-L.length-1,r=i.lastIndex,u=a.substr(0,l),p=a.substr(r,a.length),d=(u+e).length,v=u+e+p;O.push({id:t,type:n,value:e}),c(),L="",y(),x.val(v),s(),x.focus(),o.setCaratPosition(x[0],d)}function m(){return e.trim(x.val())}function d(t){var n=e(this);return p(n.attr("data-display"),n.attr("data-ref-id"),n.attr("data-ref-type")),!1}function v(e){c()}function h(e){s(),u(),y();var n=t.lastIndexOf(S,T.triggerChar);n>-1&&(L=S.slice(n+1).join(""),L=o.rtrim(L),t.defer(t.bind(E,this,L)))}function f(e){var t=String.fromCharCode(e.which||e.keyCode);S.push(t)}function g(n){if(n.keyCode!=a.LEFT&&n.keyCode!=a.RIGHT&&n.keyCode!=a.HOME&&n.keyCode!=a.END){if(n.keyCode!=a.BACKSPACE){if(!b.is(":visible"))return!0;switch(n.keyCode){case a.UP:case a.DOWN:var i=null;return(i=n.keyCode==a.DOWN?R&&R.length?R.next():b.find("li").first():e(R).prev()).length&&C(i),!1;case a.RETURN:case a.TAB:if(R&&R.length)return R.click(),!1}return!0}S=S.slice(0,-1+S.length)}else t.defer(c)}function y(){R=null,b.empty().hide()}function C(e){e.addClass(T.classes.autoCompleteItemActive),e.siblings().removeClass(T.classes.autoCompleteItemActive),R=e}function I(n,a){b.show();var i=t.pluck(O,"value");if((a=t.reject(a,function(e){return t.include(i,e.name)})).length){b.empty();var l=e("<ul>").appendTo(b).hide();t.each(a,function(t,a){var i=e(T.templates.autocompleteListItem({id:o.htmlEncode(t.id),display:o.htmlEncode(t.name),type:o.htmlEncode(t.type),content:o.highlightTerm(o.htmlEncode(t.name),n)}));if(0===a&&C(i),T.showAvatars){e(t.avatar?T.templates.autocompleteListItemAvatar({avatar:t.avatar}):T.templates.autocompleteListItemIcon({icon:t.icon})).prependTo(i)}i=i.appendTo(l)}),b.show(),l.show()}else y()}function E(e){e&&e.length&&e.length>=T.minChars&&T.onDataRequest.call(this,"search",e,function(t){I(e,t)})}var T,x,A,b,k,w,R,L,O=[],S=[];return{init:function(e){T=e,i(),l(),r()},val:function(e){if(t.isFunction(e)){var n=O.length?x.data("messageText"):m();e.call(this,n)}},reset:function(){x.val(""),O=[],s()},getMentions:function(e){t.isFunction(e)&&e.call(this,O)}}};e.fn.mentionsInput=function(n,a){"object"!=typeof n&&n||(a=e.extend(!0,{},i,n));var o=arguments;return this.each(function(){var i=e.data(this,"mentionsInput")||e.data(this,"mentionsInput",new l(this));return t.isFunction(i[n])?i[n].apply(this,Array.prototype.slice.call(o,1)):"object"!=typeof n&&n?void e.error("Method "+n+" does not exist"):i.init.call(this,a)})}}(jQuery,_);