function runTestWithRetries(e,r,t){return t=t||0,runTest(e,r).timeout(3e4).catch(Promise.TimeoutError,function(){if(t<3)return console.log(colors.violet,"Retry",t+1,r),runTestWithRetries(e,r,t+1);throw new Error("Couldn't run test after 3 retries")})}function getResults(e){return function(){return Promise.props({dataUrl:e.waitForElementByCss("body[data-complete='true']",9e4).then(function(){return e.elementsByCssSelector(".test.fail")}).then(function(r){return Array.isArray(r)?Promise.map(r,function(r){return e.text(r).then(function(e){return Promise.reject(e)})}):Promise.resolve([])})})}}function runTest(e,r){return Promise.resolve(e.then(utils.loadTestPage(e,r,port)).then(getResults(e))).cancellable()}var wd=require("wd"),http=require("http"),https=require("https"),url=require("url"),path=require("path"),Promise=require("bluebird"),_=require("lodash"),humanizeDuration=require("humanize-duration"),utils=require("../utils"),colors=utils.colors,port=8080;exports.tests=function(e,r){return(r?Promise.resolve([r]):utils.getTests("tests/mocha")).then(function(r){return Promise.map(e,function(e){var t=[e.browserName,e.version,e.platform].join("-"),o=0,n=utils.initBrowser(e);return Promise.using(n,function(){return Promise.map(r,function(e,r,s){console.log(colors.green,"STARTING","("+ ++o+"/"+s+")",t,e,colors.clear);var u=Date.now();return runTestWithRetries(n,e).then(function(){console.log(colors.green,"COMPLETE",humanizeDuration(Date.now()-u),"("+o+"/"+s+")",t,colors.clear)})},{concurrency:1}).settle().catch(function(e){throw console.error(colors.red,"ERROR",t,e),e})})},{concurrency:3})})};