!function(){"use strict;";function e(e){return new a(function(r){var t=s.decode(e);new c(t).decodePixels(r)})}function r(e,r){for(var t=e.length,n=0,o=0;n<t;n++)r[n]-e[n]!=0&&o++;return 100-Math.round(o/e.length*1e4)/100}function t(e){return function(){return a.props({dataUrl:e.waitForElementByCss(".html2canvas",15e3).then(function(r){return e.execute("return arguments[0].toDataURL('image/png').substring(22)",[r])}),screenshot:e.takeScreenshot()})}}function n(t){return function(n){return a.all([e(n.dataUrl),e(n.screenshot)]).spread(r).then(function(e){return{testCase:t,accuracy:e,dataUrl:n.dataUrl,screenshot:n.screenshot}})}}function o(e,r,t){return t=t||0,u(e,r).timeout(6e4).catch(a.TimeoutError,function(){if(t<3)return console.log(h.violet,"Retry",t+1,r),o(e,r,t+1);throw new Error("Couldn't run test after 3 retries")})}function u(e,r){return a.resolve(e.then(f.loadTestPage(e,r,g)).then(t(e)).then(n(r))).cancellable()}require("wd"),require("http"),require("https"),require("url"),require("path");var s=require("base64-arraybuffer"),c=require("png-js"),a=require("bluebird"),i=(require("lodash"),require("humanize-duration")),l=require("fs"),f=require("./utils"),h=f.colors;a.promisifyAll(l);var g=8080;exports.tests=function(e,r){return(r?a.resolve([r]):f.getTests("tests/cases")).then(function(r){return a.map(e,function(e){var t=f.initBrowser(e),n=[e.browserName,e.version,e.platform].join("-"),u=0;return a.using(t,function(){return a.map(r,function(e,r,s){console.log(h.green,"STARTING","("+ ++u+"/"+s+")",n,e,h.clear);var c=Date.now();return o(t,e).then(function(e){console.log(h.green,"COMPLETE",i(Date.now()-c),"("+u+"/"+s+")",n,e.testCase.substring("tests/cases".length),e.accuracy.toFixed(2)+"%",h.clear)})},{concurrency:1}).settle().catch(function(e){throw console.log(h.red,"ERROR",n,e.message),e})})},{concurrency:3})})}}();