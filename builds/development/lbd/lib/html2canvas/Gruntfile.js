var _=require("lodash"),path=require("path"),proxy=require("html2canvas-proxy");module.exports=function(e){var r={banner:'/*\n  <%= pkg.title || pkg.name %> <%= pkg.version %><%= pkg.homepage ? " <" + pkg.homepage + ">" : "" %>\n  Copyright (c) <%= grunt.template.today("yyyy") %> <%= pkg.author.name %>\n\n  Released under <%= _.pluck(pkg.licenses, "type").join(", ") %> License\n*/\n',pre:"\n(function(window, document, exports, global, define, undefined){\n\n",post:'\n}).call({}, typeof(window) !== "undefined" ? window : undefined, typeof(document) !== "undefined" ? document : undefined);'},s={chrome:{browserName:"chrome",platform:"Windows 7",version:"39"},firefox:{browserName:"firefox",version:"15",platform:"Windows 7"},ie9:{browserName:"internet explorer",version:"9",platform:"Windows 7"},ie10:{browserName:"internet explorer",version:"10",platform:"Windows 8"},ie11:{browserName:"internet explorer",version:"11",platform:"Windows 8.1"},safari6:{browserName:"safari",version:"6",platform:"OS X 10.8"},safari7:{browserName:"safari",platform:"OS X 10.9",version:"7"},chromeOSX:{browserName:"chrome",platform:"OS X 10.8",version:"39"}};e.initConfig({pkg:e.file.readJSON("package.json"),concat:{dist:{src:["src/promise.js","src/fallback.js","src/punycode/punycode.js","src/core.js","src/*.js","src/renderers/*.js"],nonull:!0,dest:"dist/<%= pkg.name %>.js",options:{banner:r.banner+r.pre,footer:r.post}},svg:{src:["src/fabric/dist/fabric.js"],dest:"dist/<%= pkg.name %>.svg.js",options:{banner:r.banner+"\n(function(window, document, exports, undefined){\n\n",footer:"\n}).call({}, window, document, html2canvas);"}}},connect:{server:{options:{port:8080,base:"./",keepalive:!0}},altServer:{options:{port:8083,base:"./"}},cors:{options:{port:8081,base:"./",middleware:function(e,r){return[function(e,r,s){"/tests/assets/image2.webp"===e.url?(r.setHeader("Access-Control-Allow-Origin","*"),r.end(require("fs").readFileSync("tests/assets/image2.webp"))):s()}]}}},proxy:{options:{port:8082,middleware:function(e,r){return[function(e,r,s){r.jsonp=function(s){r.end(e.query.callback+"("+JSON.stringify(s)+")")},s()},proxy()]}}},ci:{options:{port:8080,base:"./"}}},execute:{fabric:{options:{args:["modules="+["text","serialization","parser","gradient","pattern","shadow","freedrawing","image_filters","serialization"].join(","),"no-es5-compat","dest="+path.resolve(__dirname,"src/fabric/dist/")+"/"]},src:["src/fabric/build.js"]}},uglify:{dist:{src:["<%= concat.dist.dest %>"],dest:"dist/<%= pkg.name %>.min.js"},svg:{src:["<%= concat.svg.dest %>"],dest:"dist/<%= pkg.name %>.svg.min.js"},options:{banner:r.banner}},watch:{files:["src/**/*","!src/fabric/**/*"],tasks:["jshint","build"]},jshint:{all:["src/*.js","src/renderers/*.js","!src/promise.js"],options:e.file.readJSON("./.jshintrc")},mochacli:{options:{reporter:"spec"},all:["tests/node/*.js"]},mocha_phantomjs:{all:["tests/mocha/**/*.html"]},mocha_webdriver:s,webdriver:s}),e.registerTask("webdriver","Browser render tests",function(r,s){var n=require("./tests/selenium.js"),o=this.async(),t=r?[e.config.get(this.name+"."+r)]:_.values(e.config.get(this.name));n.tests(t,s).catch(function(){o(!1)}).finally(function(){console.log("Done"),o()})}),e.registerTask("mocha_webdriver","Browser mocha tests",function(r,s){var n=require("./tests/mocha/selenium.js"),o=this.async(),t=r?[e.config.get(this.name+"."+r)]:_.values(e.config.get(this.name));n.tests(t,s).catch(function(){o(!1)}).finally(function(){o()})}),e.loadNpmTasks("grunt-mocha-phantomjs"),e.loadNpmTasks("grunt-contrib-watch"),e.loadNpmTasks("grunt-contrib-concat"),e.loadNpmTasks("grunt-contrib-uglify"),e.loadNpmTasks("grunt-contrib-jshint"),e.loadNpmTasks("grunt-contrib-connect"),e.loadNpmTasks("grunt-execute"),e.loadNpmTasks("grunt-mocha-cli"),e.registerTask("server",["connect:cors","connect:proxy","connect:altServer","connect:server"]),e.registerTask("build",["execute","concat","uglify"]),e.registerTask("default",["jshint","build","mochacli","connect:altServer","mocha_phantomjs"]),e.registerTask("travis",["jshint","build","connect:altServer","connect:ci","connect:proxy","connect:cors","mocha_phantomjs","webdriver"])};